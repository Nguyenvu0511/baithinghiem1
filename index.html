<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hoàng Vũ Labs - Ultimate Physics Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .tech-font { font-family: 'JetBrains Mono', monospace; }
        .neon-border { box-shadow: 0 0 10px rgba(56, 189, 248, 0.5); }
        .input-group label { display: block; font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.25rem; }
        .input-dark { background: #1e293b; border: 1px solid #334155; color: white; padding: 4px 8px; border-radius: 4px; width: 100%; font-family: 'JetBrains Mono'; transition: all 0.2s; }
        .input-dark:focus { outline: none; border-color: #38bdf8; background: #0f172a; }
        .input-disabled { background: #334155; color: #94a3b8; cursor: not-allowed; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { border: 1px solid #334155; padding: 8px; text-align: center; }
        th { background-color: #1e293b; color: #38bdf8; }
        tr:nth-child(even) { background-color: #0f172a; }
        
        /* Range Input Styling */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #38bdf8; cursor: pointer; margin-top: -6px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px; }
        
        /* Cursor styles for ruler */
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
        #ruler { touch-action: none; user-select: none; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <!-- Header -->
    <header class="bg-slate-900 border-b border-slate-700 p-3 flex justify-between items-center shadow-lg shrink-0 z-20">
        <div class="flex items-center space-x-3">
            <div class="p-2 bg-gradient-to-br from-blue-600 to-purple-600 rounded-lg neon-border">
                <i class="fa-solid fa-atom text-white"></i>
            </div>
            <div>
                <h1 class="font-bold text-white uppercase tracking-wider text-sm md:text-base">Hoàng Vũ Labs - Ultimate</h1>
                <p class="text-[10px] text-blue-400 tech-font">MODE: V5.2 - FIX DRAGGABLE RULER</p>
            </div>
        </div>
        <div class="hidden sm:flex items-center space-x-2">
            <span class="text-xs text-slate-400">Chọn bài thí nghiệm:</span>
            <select id="labMode" class="bg-slate-800 text-white text-xs p-1 rounded border border-slate-600 focus:outline-none focus:border-blue-500">
                <option value="1">Bài 1: Ném Ngang (Tìm v0)</option>
                <option value="2">Bài 2: Ném Xiên (Góc Tùy Chỉnh)</option>
            </select>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- LEFT PANEL: CONTROL CENTER -->
        <aside class="w-full md:w-80 bg-slate-800 border-r border-slate-700 flex flex-col overflow-y-auto custom-scrollbar z-10">
            
            <div class="p-4 space-y-4">
                
                <!-- Section 1: Thông số môi trường -->
                <div class="bg-slate-900 p-3 rounded border border-slate-700 relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-1 opacity-10"><i class="fa-solid fa-earth-asia text-4xl text-white"></i></div>
                    <h3 class="text-yellow-400 font-bold text-xs uppercase mb-2 tracking-wider">1. Thông số Cố định</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="input-group">
                            <label>Gia tốc g (m/s²)</label>
                            <input type="number" id="inputG" value="9.8" step="0.01" class="input-dark">
                        </div>
                        <div class="input-group">
                            <label>Độ cao h (mm)</label>
                            <input type="number" id="inputH" value="500" class="input-dark">
                        </div>
                    </div>
                </div>

                <!-- Section 2: Chế độ Ném Ngang (Bài 1) -->
                <div id="panelMode1" class="bg-slate-900 p-3 rounded border border-blue-500/30 shadow-[0_0_10px_rgba(59,130,246,0.1)] transition-all">
                    <h3 class="text-blue-400 font-bold text-xs uppercase mb-2 flex justify-between">
                        <span>2. Ném Ngang (Tìm v0)</span>
                        <i class="fa-solid fa-1"></i>
                    </h3>
                    
                    <div class="input-group mb-2">
                        <label>Đường kính D (mm)</label>
                        <input type="number" id="inputD" value="20" class="input-dark">
                    </div>
                    <div class="input-group mb-3">
                        <label>Thời gian chắn cổng Δt (ms)</label>
                        <input type="number" id="inputTime" placeholder="Ví dụ: 5.0" class="input-dark text-yellow-300 font-bold ring-1 ring-yellow-500/50">
                    </div>

                    <div class="p-2 bg-slate-800 rounded border border-slate-600 text-center mb-2">
                        <p class="text-[10px] text-slate-400">Vận tốc v0 tính được:</p>
                        <p id="resV0_1" class="text-green-400 font-bold tech-font text-lg">---</p>
                        <p class="text-[10px] text-slate-500">m/s</p>
                    </div>
                    <p class="text-[10px] text-slate-500 italic">*Nhập Δt rồi bấm KHAI HỎA để thấy bóng!</p>
                </div>

                <!-- Section 3: Chế độ Ném Xiên (Bài 2) -->
                <div id="panelMode2" class="bg-slate-900 p-3 rounded border border-purple-500/30 shadow-[0_0_10px_rgba(168,85,247,0.1)] opacity-50 pointer-events-none transition-all">
                    <h3 class="text-purple-400 font-bold text-xs uppercase mb-2 flex justify-between">
                        <span>2. Ném Xiên (Góc Tùy Chỉnh)</span>
                        <i class="fa-solid fa-unlock text-xs"></i>
                    </h3>

                    <div class="input-group mb-2">
                        <label class="flex justify-between">
                            <span>Vận tốc đầu v0 (m/s)</span>
                            <button id="btnAutoV0" class="text-[10px] text-blue-400 hover:text-white underline font-bold bg-slate-800 px-2 rounded border border-blue-500">Lấy TB từ Bảng 1</button>
                        </label>
                        <input type="number" id="inputV0_Manual" value="3.5" step="0.01" class="input-dark text-green-300 font-bold">
                    </div>

                    <div class="mb-3">
                        <label class="flex justify-between text-xs text-slate-400 mb-1">
                            <span>Góc ném (α)</span>
                            <span id="angleDisplay" class="text-white font-bold">45°</span>
                        </label>
                        <!-- UNLOCKED SLIDER 0-100 -->
                        <input type="range" id="inputAngle" min="0" max="100" value="45" step="1" class="cursor-pointer accent-purple-500">
                        <div class="flex justify-between text-[10px] text-slate-600 px-1">
                            <span>0°</span><span>50°</span><span>100°</span>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="space-y-2">
                    <div class="bg-slate-800 p-2 rounded flex justify-between items-center border border-slate-600">
                        <span class="text-xs text-slate-300">L_lý_thuyết:</span>
                        <span id="calcLtt" class="text-green-400 font-bold tech-font">0.0 mm</span>
                    </div>
                    
                    <button id="btnSimulate" class="w-full bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-bold py-2 rounded text-sm shadow-lg transform active:scale-95 transition-all">
                        <i class="fa-solid fa-rocket mr-1"></i> KHAI HỎA (FIRE)
                    </button>

                    <div class="flex gap-2">
                        <div class="bg-slate-900 border border-slate-700 rounded p-2 flex-1 text-center">
                            <p class="text-[10px] text-slate-400">Đo được (Thước)</p>
                            <p id="measureResult" class="text-purple-400 font-bold tech-font text-sm">0 mm</p>
                        </div>
                        <button id="btnRecord" class="bg-green-600 hover:bg-green-500 text-white font-bold px-4 rounded text-xs shadow-lg flex flex-col justify-center items-center w-24 transform active:scale-95 transition-all">
                            <i class="fa-solid fa-save mb-1"></i> GHI SỐ
                        </button>
                    </div>
                </div>
                
            </div>
        </aside>

        <!-- RIGHT PANEL: VISUALIZATION -->
        <main class="flex-1 flex flex-col bg-slate-950 relative">
            <!-- Canvas -->
            <div class="relative flex-1 overflow-hidden border-b border-slate-700 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')]">
                <canvas id="simCanvas" class="w-full h-full block cursor-crosshair"></canvas>
                
                <!-- Ruler (Đã nâng lên cao & FIX lỗi kéo thả) -->
                <!-- Thêm lớp z-50 và vùng bấm rộng hơn -->
                <div id="ruler" class="absolute bottom-32 left-10 flex flex-col items-center group z-50 cursor-grab active:cursor-grabbing" style="transform: translateX(0px);">
                    
                    <!-- Vùng tương tác rộng vô hình để dễ bấm (invisible hit area) -->
                    <div class="absolute -inset-4 bg-transparent z-40"></div>

                    <!-- Mũi tên -->
                    <div class="w-0 h-0 border-x-8 border-x-transparent border-t-[12px] border-t-red-500 animate-bounce filter drop-shadow-[0_0_5px_rgba(239,68,68,0.8)] pointer-events-none relative z-50"></div>
                    
                    <!-- Thân thước -->
                    <div class="bg-yellow-400 text-black font-bold text-xs px-2 py-1 rounded shadow-lg border-2 border-yellow-600 min-w-[90px] text-center select-none relative z-50">
                        <i class="fa-solid fa-ruler-combined mr-1"></i> <span id="rulerVal">0 mm</span>
                    </div>
                    
                    <!-- Dây dọi (Visual) -->
                    <div class="w-px h-[2000px] bg-red-500/60 absolute top-full left-1/2 -translate-x-1/2 border-l border-dashed border-red-500 pointer-events-none"></div>
                    
                    <!-- Dây dọi (Hit Area - Lớp tàng hình rộng 10px để dễ kéo) -->
                    <div class="w-4 h-[2000px] bg-transparent absolute top-full left-1/2 -translate-x-1/2 cursor-col-resize z-40"></div>
                </div>

                <!-- HUD Info -->
                <div class="absolute top-4 right-4 text-right pointer-events-none z-40">
                    <div class="text-slate-500 text-xs">TRẠNG THÁI BÓNG</div>
                    <div class="text-blue-400 font-mono text-xs" id="hudVx">Vx: 0.00 m/s</div>
                    <div class="text-green-400 font-mono text-xs" id="hudVy">Vy: 0.00 m/s</div>
                    <div id="ballStatus" class="text-yellow-500 font-bold text-xs mt-1">SẴN SÀNG</div>
                </div>
            </div>

            <!-- Data Tables Container -->
            <div class="h-64 bg-slate-900 overflow-hidden flex flex-col">
                <div class="flex justify-between items-center px-4 py-2 bg-slate-800 sticky top-0 z-10 border-b border-slate-700">
                    <h3 class="text-white font-bold text-xs uppercase" id="tableTitle">BẢNG SỐ LIỆU 1 (NÉM NGANG)</h3>
                    <button onclick="clearCurrentTable()" class="text-[10px] text-red-400 hover:text-red-200 uppercase tracking-wider"><i class="fa-solid fa-trash"></i> Xóa bảng này</button>
                </div>
                
                <div class="flex-1 overflow-auto custom-scrollbar relative">
                    <!-- Table 1: Ném Ngang -->
                    <table id="table1" class="w-full">
                        <thead class="bg-slate-800 text-xs sticky top-0 text-slate-300">
                            <tr>
                                <th>Lần</th>
                                <th>Δt (ms)</th>
                                <th>v0 (m/s)</th>
                                <th>L_tn (mm)</th>
                                <th>L_tt (mm)</th>
                                <th>Sai số (%)</th>
                            </tr>
                        </thead>
                        <tbody id="tbody1" class="text-xs font-mono"></tbody>
                    </table>

                    <!-- Table 2: Ném Xiên -->
                    <table id="table2" class="w-full hidden">
                        <thead class="bg-slate-800 text-xs sticky top-0 text-slate-300">
                            <tr>
                                <th>Lần</th>
                                <th>Góc (α)</th>
                                <th>v0 (TB)</th>
                                <th>t_bay (s)</th>
                                <th>L_tn (mm)</th>
                                <th>L_tt (mm)</th>
                                <th>Sai số (%)</th>
                            </tr>
                        </thead>
                        <tbody id="tbody2" class="text-xs font-mono"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- HOANG VU PHYSICS ENGINE V5.2 (FIXED DRAGGING) ---
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const SCALE = 0.4; 
        
        let state = {
            mode: 1, // 1: Ném Ngang, 2: Ném Xiên
            g: 9.8,
            h: 500, // mm
            v0: 0, 
            angle: 0, 
            dt: 0,
            flightTime: 0, 
            ball: null,
            Ltt: 0,
            Ltn: 0
        };
        
        let data1 = []; 
        let counts = { 1: 0, 2: 0 };

        function init() {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            document.getElementById('labMode').addEventListener('change', (e) => {
                setMode(parseInt(e.target.value));
            });
            
            document.getElementById('inputAngle').addEventListener('input', (e) => {
                document.getElementById('angleDisplay').textContent = e.target.value + '°';
                calculatePhysics();
            });
            
            ['inputG', 'inputH', 'inputD', 'inputTime', 'inputV0_Manual'].forEach(id => {
                document.getElementById(id).addEventListener('input', calculatePhysics);
            });

            document.getElementById('btnSimulate').addEventListener('click', fire);
            document.getElementById('btnRecord').addEventListener('click', record);
            
            document.getElementById('btnAutoV0').addEventListener('click', () => {
                if(data1.length === 0) {
                    alert("Chưa có dữ liệu ở Bảng 1 để tính!");
                    return;
                }
                const sumV0 = data1.reduce((a, b) => a + b, 0);
                const avgV0 = sumV0 / data1.length;
                document.getElementById('inputV0_Manual').value = avgV0.toFixed(3);
                calculatePhysics();
                alert(`Đã chuyển v0 trung bình (${avgV0.toFixed(3)} m/s) sang Bảng 2!`);
            });

            setupRuler();
            setMode(1); 
            
            // Start Infinite Loop
            loop();
        }

        function setMode(m) {
            state.mode = m;
            const p1 = document.getElementById('panelMode1');
            const p2 = document.getElementById('panelMode2');
            const t1 = document.getElementById('table1');
            const t2 = document.getElementById('table2');
            const title = document.getElementById('tableTitle');

            if(m === 1) {
                p1.style.opacity = '1'; p1.style.pointerEvents = 'auto';
                p2.style.opacity = '0.5'; p2.style.pointerEvents = 'none';
                t1.classList.remove('hidden');
                t2.classList.add('hidden');
                title.textContent = "BẢNG SỐ LIỆU 1 (NÉM NGANG)";
                state.angle = 0;
            } else {
                p1.style.opacity = '0.5'; p1.style.pointerEvents = 'none';
                p2.style.opacity = '1'; p2.style.pointerEvents = 'auto';
                t1.classList.add('hidden');
                t2.classList.remove('hidden');
                title.textContent = "BẢNG SỐ LIỆU 2 (NÉM XIÊN)";
                state.angle = parseFloat(document.getElementById('inputAngle').value);
            }
            calculatePhysics();
            state.ball = null; 
            updateStatus("SẴN SÀNG");
        }

        function calculatePhysics() {
            state.g = parseFloat(document.getElementById('inputG').value) || 9.8;
            state.h = parseFloat(document.getElementById('inputH').value) || 0;

            if(state.mode === 1) {
                const D = parseFloat(document.getElementById('inputD').value) || 20;
                const dt = parseFloat(document.getElementById('inputTime').value) || 0;
                
                if(dt > 0) {
                    state.v0 = D / dt; 
                    state.dt = dt;
                    document.getElementById('resV0_1').textContent = state.v0.toFixed(3);
                } else {
                    state.v0 = 0;
                }
                state.angle = 0;
            } else {
                state.v0 = parseFloat(document.getElementById('inputV0_Manual').value) || 0;
                state.angle = parseFloat(document.getElementById('inputAngle').value);
            }

            if(state.v0 > 0) {
                const rad = state.angle * Math.PI / 180;
                const h_m = state.h / 1000;
                const vy0 = state.v0 * Math.sin(rad);
                const vx0 = state.v0 * Math.cos(rad);
                
                const delta = vy0*vy0 + 2*state.g*h_m;
                const t_flight = (vy0 + Math.sqrt(delta)) / state.g;
                
                const L_m = vx0 * t_flight;
                state.Ltt = L_m * 1000; 
                
                document.getElementById('calcLtt').textContent = state.Ltt.toFixed(1) + ' mm';
            }
        }

        function fire() {
            calculatePhysics();
            
            if(state.mode === 1 && state.v0 <= 0) {
                alert("Hoàng Vũ ơi! Hãy nhập thời gian Δt (ms) vào ô màu vàng đã!");
                return;
            }
            
            if(state.v0 <= 0) return;

            const rad = state.angle * Math.PI / 180;
            state.ball = {
                x: 0,
                y: state.h,
                vx: state.v0 * Math.cos(rad) * 1000, 
                vy: state.v0 * Math.sin(rad) * 1000, 
                t: 0,
                landed: false,
                path: [{x:0, y:state.h}] // Start path
      
