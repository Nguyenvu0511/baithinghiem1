import React, { useState, useEffect, useRef } from 'react';
import { Play, RotateCcw, Save, Trash2, Info, Settings, Wind, Ruler } from 'lucide-react';

const App = () => {
  // --- Hằng số vật lý ---
  const G = 9.81; // Gia tốc trọng trường (m/s^2)
  
  // --- Trạng thái hệ thống (Input theo mẫu báo cáo) ---
  const [voltage, setVoltage] = useState(15); 
  const [angle, setAngle] = useState(30); 
  const [h0_mm, setH0mm] = useState(500); // Chiều cao ban đầu (mm)
  const [d_mm, setDmm] = useState(40); // Đường kính bóng (mm)
  const [ballMass, setBallMass] = useState(0.0027); // kg
  const [useAirResistance, setUseAirResistance] = useState(false);
  
  const [isLaunching, setIsLaunching] = useState(false);
  const [path, setPath] = useState([]);
  const [results, setResults] = useState([]);
  const [timerData, setTimerData] = useState({ dt: "0", v0: "0" });
  const [experimentalRange, setExperimentalRange] = useState("0");

  const canvasRef = useRef(null);

  // Tính v0 giả lập từ điện áp (v0 = D / dt)
  const calculateV0 = (v) => {
    // Giả định tốc độ động cơ tỉ lệ thuận với điện áp
    const baseV0 = (v - 10) * 1.5 + 2; 
    const noise = (Math.random() - 0.5) * 0.05; // Nhiễu nhỏ cho thực tế
    return baseV0 + noise;
  };

  const launch = () => {
    if (isLaunching) return;
    
    const v0 = calculateV0(voltage);
    const d_m = d_mm / 1000;
    const dt = (d_m / v0) * 1000; // ms
    
    setTimerData({ dt: dt.toFixed(2), v0: v0.toFixed(2) });
    setIsLaunching(true);
    setPath([]);

    const dt_step = 0.01;
    let currX = 0;
    let currY = h0_mm / 1000; // Đổi sang mét để tính toán vật lý
    let vx = v0 * Math.cos((angle * Math.PI) / 180);
    let vy = v0 * Math.sin((angle * Math.PI) / 180);
    
    const newPath = [];
    const airDensity = 1.225;
    const dragCoeff = 0.47;
    const area = Math.PI * Math.pow(d_m/2, 2);

    const interval = setInterval(() => {
      newPath.push({ x: currX, y: currY });
      
      if (useAirResistance) {
        const v = Math.sqrt(vx*vx + vy*vy);
        const dragF = 0.5 * airDensity * v * v * dragCoeff * area;
        const ax = -(dragF * (vx/v)) / ballMass;
        const ay = -G - (dragF * (vy/v)) / ballMass;
        vx += ax * dt_step;
        vy += ay * dt_step;
      } else {
        vy -= G * dt_step;
      }

      currX += vx * dt_step;
      currY += vy * dt_step;

      if (currY <= 0) {
        currY = 0;
        newPath.push({ x: currX, y: currY });
        setExperimentalRange(currX.toFixed(4));
        setPath(newPath);
        setIsLaunching(false);
        clearInterval(interval);
      }
      setPath([...newPath]);
    }, 10);
  };

  const reset = () => {
    setPath([]);
    setTimerData({ dt: "0", v0: "0" });
    setExperimentalRange("0");
    setIsLaunching(false);
  };

  const saveToTable = () => {
    const v0 = parseFloat(timerData.v0);
    const rad = (angle * Math.PI) / 180;
    const h0_m = h0_mm / 1000;
    
    // Công thức tính thời gian chuyển động t từ ảnh
    const t_calc = (v0 * Math.sin(rad) + Math.sqrt(Math.pow(v0 * Math.sin(rad), 2) + 2 * G * h0_m)) / G;
    // Công thức tầm xa lý thuyết LTT = v0 * cos(theta) * t
    const L_TT_m = v0 * Math.cos(rad) * t_calc;
    
    const L_TN_m = parseFloat(experimentalRange);
    const error = Math.abs((L_TN_m - L_TT_m) / L_TT_m) * 100;

    const newResult = {
      id: Date.now(),
      angle: angle,
      dt: timerData.dt,
      v0: timerData.v0,
      ltt: (L_TT_m * 1000).toFixed(1), // Đổi sang mm cho bảng
      ltn: (L_TN_m * 1000).toFixed(1), // Đổi sang mm cho bảng
      error: error.toFixed(2)
    };
    setResults([newResult, ...results].slice(0, 10));
  };

  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const w = canvas.width;
    const h = canvas.height;
    const scale = 150; 
    const offsetX = 50;
    const offsetY = h - 50;

    ctx.clearRect(0, 0, w, h);

    // Lưới
    ctx.strokeStyle = '#f1f5f9';
    ctx.lineWidth = 1;
    for (let i = 0; i < w; i += 50) { ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, h); ctx.stroke(); }
    for (let i = 0; i < h; i += 50) { ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(w, i); ctx.stroke(); }

    // Trục
    ctx.strokeStyle = '#94a3b8';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(offsetX, 0); ctx.lineTo(offsetX, offsetY); ctx.lineTo(w, offsetY);
    ctx.stroke();

    // Vẽ giá phóng
    ctx.save();
    ctx.translate(offsetX, offsetY - (h0_mm / 1000) * scale);
    ctx.rotate(-angle * Math.PI / 180);
    ctx.fillStyle = '#475569';
    ctx.fillRect(-5, -10, 50, 20); 
    ctx.restore();

    // Vẽ quỹ đạo
    if (path.length > 1) {
      ctx.beginPath();
      ctx.setLineDash([4, 4]);
      ctx.strokeStyle = '#f43f5e';
      ctx.moveTo(offsetX + path[0].x * scale, offsetY - path[0].y * scale);
      for (let i = 1; i < path.length; i++) {
        ctx.lineTo(offsetX + path[i].x * scale, offsetY - path[i].y * scale);
      }
      ctx.stroke();
      ctx.setLineDash([]);
    }

    // Vẽ bóng
    if (path.length > 0) {
      const last = path[path.length - 1];
      ctx.beginPath();
      ctx.arc(offsetX + last.x * scale, offsetY - last.y * scale, 6, 0, Math.PI * 2);
      ctx.fillStyle = '#f59e0b';
      ctx.fill();
    }
  }, [path, angle, h0_mm]);

  return (
    <div className="flex flex-col h-screen bg-slate-100 text-slate-800 font-sans p-4 overflow-hidden">
      {/* Top Header */}
      <div className="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border mb-4">
        <div>
          <h1 className="text-lg font-bold uppercase tracking-tight text-blue-900">Báo cáo Thí nghiệm Số 1</h1>
          <p className="text-xs text-slate-500 italic">Khảo sát chuyển động ném ngang, ném xiên - ĐH Duy Tân</p>
        </div>
        <div className="bg-slate-900 p-2 rounded-lg border-2 border-slate-700 shadow-inner">
           <div className="text-[10px] text-blue-400 font-bold mb-1 uppercase text-center">Photogate Timer ($\Delta t$)</div>
           <div className="text-3xl font-mono text-red-500 font-bold px-4 tracking-widest">
             {timerData.dt.padStart(5, '0')} <span className="text-sm font-normal">ms</span>
           </div>
        </div>
      </div>

      <div className="flex flex-1 gap-4 overflow-hidden">
        {/* Left Panel: Inputs */}
        <div className="w-72 flex flex-col gap-3 overflow-y-auto pr-1">
          <div className="bg-white p-4 rounded-xl shadow-sm border">
            <h2 className="text-xs font-bold uppercase mb-3 flex items-center gap-2 border-b pb-2">
              <Settings className="w-4 h-4" /> THIẾT LẬP THÔNG SỐ
            </h2>
            
            <div className="space-y-4">
              <div>
                <label className="text-[11px] font-bold block mb-1 uppercase">{"Đường kính bóng $D$ (mm):"}</label>
                <input 
                  type="number" value={d_mm} onChange={(e) => setDmm(parseFloat(e.target.value))}
                  className="w-full bg-slate-50 border rounded p-1.5 text-sm font-mono focus:ring-1 focus:ring-blue-500"
                />
              </div>

              <div>
                <label className="text-[11px] font-bold block mb-1 uppercase">{"Chiều cao $h_0$ (mm):"}</label>
                <input 
                  type="number" value={h0_mm} onChange={(e) => setH0mm(parseFloat(e.target.value))}
                  className="w-full bg-slate-50 border rounded p-1.5 text-sm font-mono"
                />
              </div>

              <div>
                <div className="flex justify-between text-[11px] font-bold mb-1 uppercase">
                  <span>{"Góc ném $\\theta_0$:"}</span>
                  <span className="text-blue-600 font-mono">{angle}°</span>
                </div>
                <input 
                  type="range" min="0" max="90" step="5" value={angle} 
                  onChange={(e) => setAngle(parseInt(e.target.value))}
                  className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                />
              </div>

              <div>
                <div className="flex justify-between text-[11px] font-bold mb-1 uppercase">
                  <span>{"Điện áp ném (V):"}</span>
                  <span className="text-blue-600 font-mono">{voltage} V</span>
                </div>
                <input 
                  type="range" min="12" max="17" step="0.1" value={voltage} 
                  onChange={(e) => setVoltage(parseFloat(e.target.value))}
                  className="w-full h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                />
              </div>

              <div className="flex items-center gap-2 pt-2 border-t">
                <input 
                  type="checkbox" id="airRes" checked={useAirResistance}
                  onChange={(e) => setUseAirResistance(e.target.checked)}
                />
                <label htmlFor="airRes" className="text-xs font-medium cursor-pointer flex items-center gap-1">
                  <Wind className="w-3 h-3 text-slate-400" /> Sức cản không khí
                </label>
              </div>
            </div>
          </div>

          <button 
            onClick={launch} disabled={isLaunching}
            className={`w-full py-3 rounded-xl font-bold text-white shadow-lg transition-all ${isLaunching ? 'bg-slate-400' : 'bg-blue-600 hover:bg-blue-700 active:scale-95'}`}
          >
            PHÓNG BÓNG
          </button>

          <div className="grid grid-cols-2 gap-2">
            <button onClick={reset} className="flex items-center justify-center gap-1 py-2 bg-slate-200 hover:bg-slate-300 rounded-lg text-xs font-bold uppercase transition-all">
              <RotateCcw className="w-3 h-3" /> RESET
            </button>
            <button onClick={saveToTable} disabled={path.length === 0 || isLaunching} className="flex items-center justify-center gap-1 py-2 bg-emerald-100 text-emerald-700 hover:bg-emerald-200 rounded-lg text-xs font-bold uppercase transition-all disabled:opacity-50">
              <Save className="w-3 h-3" /> LƯU
            </button>
          </div>
        </div>

        {/* Right Panel: Simulation & Table */}
        <div className="flex-1 flex flex-col gap-4 overflow-hidden">
          {/* Canvas Section */}
          <div className="flex-1 bg-white rounded-xl shadow-sm border relative overflow-hidden">
            <div className="absolute top-3 left-3 flex flex-col gap-1 z-10">
               <div className="bg-white/90 backdrop-blur p-2 rounded border shadow-sm text-[10px] space-y-1">
                 <p className="font-bold border-b pb-1 mb-1">CÔNG THỨC ÁP DỤNG</p>
                 <p>{"$t = \\frac{v_0\\sin\\theta_0 + \\sqrt{(v_0\\sin\\theta_0)^2 + 2gh_0}}{g}$"}</p>
                 <p>{"$L_{TT} = v_0\\cos\\theta_0 \\cdot t$"}</p>
                 <p>{"$v_0 = D / \\Delta t$"}</p>
               </div>
            </div>
            
            <canvas ref={canvasRef} width={800} height={500} className="w-full h-full" />

            <div className="absolute bottom-3 right-3 bg-white/90 p-3 rounded-lg border shadow-sm text-xs font-mono">
              <div className="text-blue-700">{"$v_0$ thực: "} <span className="font-bold">{timerData.v0} m/s</span></div>
              <div className="text-red-700">{"$L_{TN}$ thực: "} <span className="font-bold">{(experimentalRange * 1000).toFixed(1)} mm</span></div>
            </div>
          </div>

          {/* Table Section */}
          <div className="h-56 bg-white rounded-xl shadow-sm border flex flex-col">
            <div className="p-2.5 border-b bg-slate-50 flex justify-between items-center">
              <h3 className="text-[11px] font-bold uppercase text-slate-600 flex items-center gap-2">
                <Ruler className="w-4 h-4" /> BẢNG SỐ LIỆU 2: KHẢO SÁT CHUYỂN ĐỘNG NÉM XIÊN
              </h3>
              <button onClick={() => setResults([])} className="text-slate-400 hover:text-red-600">
                <Trash2 className="w-4 h-4" />
              </button>
            </div>
            <div className="overflow-auto flex-1">
              <table className="w-full text-center text-[11px]">
                <thead className="bg-slate-50 sticky top-0 border-b">
                  <tr>
                    <th className="p-2 border-r">Lần đo</th>
                    <th className="p-2 border-r">{"$\\Delta t$ (ms)"}</th>
                    <th className="p-2 border-r">{"$v_0$ (m/s)"}</th>
                    <th className="p-2 border-r">{"$L_{TT}$ (mm)"}</th>
                    <th className="p-2 border-r">{"$L_{TN}$ (mm)"}</th>
                    <th className="p-2">{"Độ lệch $\\delta$ (%)"}</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {results.map((r, i) => (
                    <tr key={r.id} className="hover:bg-slate-50">
                      <td className="p-2 font-bold">{results.length - i}</td>
                      <td className="p-2 font-mono">{r.dt}</td>
                      <td className="p-2 font-mono">{r.v0}</td>
                      <td className="p-2 font-mono">{r.ltt}</td>
                      <td className="p-2 font-mono font-bold text-blue-600">{r.ltn}</td>
                      <td className={`p-2 font-bold ${parseFloat(r.error) > 5 ? 'text-red-500' : 'text-emerald-600'}`}>
                        {r.error}
                      </td>
                    </tr>
                  ))}
                  {results.length === 0 && (
                    <tr>
                      <td colSpan="6" className="p-8 italic text-slate-400">Chưa có dữ liệu thí nghiệm.</td>
                    </tr>
                  )}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <div className="mt-3 text-[10px] text-slate-400 flex justify-between italic">
        <span>* Ghi chú: Sử dụng thước kẹp để đo $D$, thước mét để đo $h_0$ trước khi ném.</span>
        <span>Version: DTU-Phys-1.2 (Stable)</span>
      </div>
    </div>
  );
};

export default App;

          
