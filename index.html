<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hoàng Vũ - Trợ Lý Thí Nghiệm Vật Lý 1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .tech-font { font-family: 'JetBrains Mono', monospace; }
        .neon-border { box-shadow: 0 0 10px rgba(56, 189, 248, 0.5); }
        .input-group label { display: block; font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.25rem; }
        .input-dark { background: #1e293b; border: 1px solid #334155; color: white; padding: 4px 8px; border-radius: 4px; width: 100%; font-family: 'JetBrains Mono'; }
        .input-dark:focus { outline: none; border-color: #38bdf8; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { border: 1px solid #334155; padding: 8px; text-align: center; }
        th { background-color: #1e293b; color: #38bdf8; }
        tr:nth-child(even) { background-color: #0f172a; }
        tr:hover { background-color: #1e293b; }
        
        /* Ruler Styling */
        #ruler { cursor: grab; touch-action: none; }
        #ruler:active { cursor: grabbing; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <!-- Header -->
    <header class="bg-slate-900 border-b border-slate-700 p-3 flex justify-between items-center shadow-lg shrink-0">
        <div class="flex items-center space-x-3">
            <div class="p-2 bg-blue-600 rounded-lg neon-border">
                <i class="fa-solid fa-microscope text-white"></i>
            </div>
            <div>
                <h1 class="font-bold text-white uppercase tracking-wider text-sm md:text-base">Hoàng Vũ Labs - Xử Lý Số Liệu</h1>
                <p class="text-[10px] text-blue-400 tech-font">AUTO_CALC_MODE: ON | NÉM NGANG</p>
            </div>
        </div>
        <div class="text-right hidden sm:block">
            <p class="text-xs text-slate-400">Trạng thái:</p>
            <p class="text-xs font-bold text-green-400">Đang hoạt động tốt ⚡</p>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- LEFT PANEL: NHẬP SỐ LIỆU THỰC TẾ -->
        <aside class="w-full md:w-80 bg-slate-800 border-r border-slate-700 flex flex-col overflow-y-auto">
            
            <div class="p-4 space-y-4">
                <!-- 1. Cấu hình chung -->
                <div class="bg-slate-900 p-3 rounded border border-slate-700">
                    <h3 class="text-yellow-400 font-bold text-sm mb-2"><i class="fa-solid fa-gear"></i> THÔNG SỐ CỐ ĐỊNH</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="input-group">
                            <label>Gia tốc g (m/s²)</label>
                            <input type="number" id="inputG" value="9.8" step="0.01" class="input-dark">
                        </div>
                        <div class="input-group">
                            <label>Đường kính D (mm)</label>
                            <input type="number" id="inputD" value="20" class="input-dark">
                        </div>
                         <div class="input-group col-span-2">
                            <label>Độ cao h (mm)</label>
                            <input type="number" id="inputH" value="800" class="input-dark">
                        </div>
                    </div>
                </div>

                <!-- 2. Nhập liệu từng lần đo -->
                <div class="bg-slate-900 p-3 rounded border border-slate-700">
                    <h3 class="text-blue-400 font-bold text-sm mb-2"><i class="fa-solid fa-stopwatch"></i> NHẬP KẾT QUẢ ĐO</h3>
                    
                    <div class="input-group mb-3">
                        <label>Thời gian Δt (ms) - Nhìn trên máy đo</label>
                        <input type="number" id="inputTime" placeholder="Ví dụ: 5.25" class="input-dark text-lg text-yellow-300 font-bold">
                    </div>

                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <div class="p-2 bg-slate-800 rounded border border-slate-600 text-center">
                            <p class="text-[10px] text-slate-400">Vận tốc v0 (tính)</p>
                            <p id="calcV0" class="text-green-400 font-bold tech-font text-sm">--- m/s</p>
                        </div>
                        <div class="p-2 bg-slate-800 rounded border border-slate-600 text-center">
                            <p class="text-[10px] text-slate-400">L_lý_thuyết (tính)</p>
                            <p id="calcLtt" class="text-green-400 font-bold tech-font text-sm">--- mm</p>
                        </div>
                    </div>

                    <button id="btnSimulate" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded text-sm transition shadow-lg mb-2">
                        <i class="fa-solid fa-play"></i> MÔ PHỎNG & TÍNH TOÁN
                    </button>
                    <p class="text-[10px] text-slate-500 italic text-center">*Hệ thống sẽ tự tính v0 và L_tt cho cậu</p>
                </div>

                <!-- 3. Kết quả đo thực tế -->
                <div class="bg-slate-900 p-3 rounded border border-slate-700">
                    <h3 class="text-purple-400 font-bold text-sm mb-2"><i class="fa-solid fa-ruler"></i> KẾT QUẢ THỰC NGHIỆM</h3>
                    <p class="text-xs text-slate-400 mb-2">Kéo thước trên màn hình đến điểm rơi để lấy L_tn</p>
                    
                    <div class="flex justify-between items-center bg-slate-800 p-2 rounded mb-2">
                        <span class="text-xs">L_tn (Đo bằng thước ảo):</span>
                        <span id="measureResult" class="text-purple-300 font-bold tech-font">0 mm</span>
                    </div>
                    
                    <button id="btnRecord" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded text-sm transition shadow-lg">
                        <i class="fa-solid fa-save"></i> GHI VÀO BẢNG
                    </button>
                </div>
            </div>
        </aside>

        <!-- RIGHT PANEL: MÔ PHỎNG & BẢNG -->
        <main class="flex-1 flex flex-col bg-slate-950 relative">
            <!-- Canvas Visualizer -->
            <div class="relative flex-1 overflow-hidden border-b border-slate-700">
                <canvas id="simCanvas" class="w-full h-full block cursor-crosshair"></canvas>
                
                <!-- Thước đo ảo -->
                <div id="ruler" class="absolute bottom-10 left-10 flex flex-col items-center group z-50" style="transform: translateX(0px);">
                    <div class="w-0 h-0 border-x-8 border-x-transparent border-t-[12px] border-t-red-500 animate-bounce"></div>
                    <div class="bg-yellow-400 text-black font-bold text-xs px-2 py-1 rounded shadow-lg border border-yellow-600 min-w-[80px] text-center select-none">
                        <i class="fa-solid fa-ruler-horizontal"></i> <span id="rulerVal">0 mm</span>
                    </div>
                    <!-- Đường gióng -->
                    <div class="w-px h-[1000px] bg-red-500/50 absolute top-full left-1/2 -translate-x-1/2 border-l border-dashed border-red-500"></div>
                </div>

                <div class="absolute top-2 right-2 bg-black/60 px-3 py-1 rounded text-xs text-white">
                    <i class="fa-solid fa-info-circle"></i> View: Mặt cắt ngang
                </div>
            </div>

            <!-- Data Table (Mô phỏng bảng báo cáo) -->
            <div class="h-64 bg-slate-900 overflow-auto p-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-white font-bold text-sm">BẢNG SỐ LIỆU 1: KHẢO SÁT CHUYỂN ĐỘNG NÉM NGANG</h3>
                    <button onclick="clearTable()" class="text-xs text-red-400 hover:text-red-300"><i class="fa-solid fa-trash"></i> Xóa bảng</button>
                </div>
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Lần đo</th>
                            <th>Δt (ms)</th>
                            <th>v0 (m/s)</th>
                            <th>L_tn (mm)<br><span class="text-[9px] font-normal">(Thực nghiệm)</span></th>
                            <th>L_tt (mm)<br><span class="text-[9px] font-normal">(Lý thuyết)</span></th>
                            <th>Độ lệch (%)</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Rows will be added here -->
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script>
        // --- LOGIC HOÀNG VŨ AUTOMATION ---

        // Biến toàn cục
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const SCALE = 0.5; // 1mm thực tế = 0.5px màn hình (để hiển thị được 1-2m)
        
        // Trạng thái
        let state = {
            g: 9.8,
            D: 20, // mm
            h: 800, // mm
            dt: 0, // ms
            v0: 0, // m/s
            Ltt: 0, // mm
            Ltn: 0, // mm (đo bằng thước ảo)
            ball: null
        };
        
        let measurementCount = 0;

        // Khởi tạo
        function init() {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Input listeners
            ['inputG', 'inputD', 'inputH', 'inputTime'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateCalculations);
            });

            document.getElementById('btnSimulate').addEventListener('click', runSimulation);
            document.getElementById('btnRecord').addEventListener('click', recordData);

            setupRuler();
            drawScene(); // Vẽ trạng thái tĩnh ban đầu
        }

        function resizeCanvas() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
            drawScene();
        }

        // --- 1. LOGIC TÍNH TOÁN VẬT LÝ ---
        function updateCalculations() {
            // Lấy giá trị từ input
            state.g = parseFloat(document.getElementById('inputG').value) || 9.8;
            state.D = parseFloat(document.getElementById('inputD').value) || 20;
            state.h = parseFloat(document.getElementById('inputH').value) || 0;
            state.dt = parseFloat(document.getElementById('inputTime').value) || 0;

            if (state.dt > 0) {
                // Tính v0 = D (mm) / dt (ms) = m/s
                state.v0 = state.D / state.dt;
                
                // Tính L_tt = v0 * sqrt(2h/g)
                // h phải đổi ra m: state.h / 1000
                const h_m = state.h / 1000;
                const t_flight = Math.sqrt((2 * h_m) / state.g);
                const L_m = state.v0 * t_flight;
                state.Ltt = L_m * 1000; // Đổi lại ra mm
                
                // Hiển thị kết quả tính
                document.getElementById('calcV0').textContent = state.v0.toFixed(3) + ' m/s';
                document.getElementById('calcLtt').textContent = state.Ltt.toFixed(1) + ' mm';
            } else {
                document.getElementById('calcV0').textContent = '---';
                document.getElementById('calcLtt').textContent = '---';
            }
        }

        // --- 2. LOGIC MÔ PHỎNG (VISUAL) ---
        function runSimulation() {
            updateCalculations();
            if(state.v0 <= 0) {
                alert("Hoàng Vũ ơi! Nhập thời gian Δt vào để tính vận tốc đã!");
                return;
            }

            // Reset ball
            state.ball = {
                x: 0, 
                y: state.h, // mm
                vx: state.v0 * 1000, // Đổi m/s ra mm/s cho đồng nhất đơn vị tính toán
                vy: 0,
                t: 0
            };
            
            animate();
        }

        function animate() {
            if(!state.ball) return;
            
            const dt = 0.016; // s (animation step)
            // Tính toán vật lý từng bước
            state.ball.t += dt;
            state.ball.x = state.ball.vx * state.ball.t; // x = v0 * t
            state.ball.y = state.h - 0.5 * (state.g * 1000) * state.ball.t * state.ball.t; // y = h - 0.5gt^2 (g đổi ra mm/s^2)

            if(state.ball.y <= 0) {
                state.ball.y = 0;
                drawScene();
                // Dừng animation
                state.ball = null; 
                return;
            }

            drawScene();
            requestAnimationFrame(animate);
        }

        function drawScene() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const originX = 50;
            const originY = canvas.height - 50; // Sàn nhà

            // Vẽ sàn
            ctx.beginPath();
            ctx.strokeStyle = '#38bdf8';
            ctx.moveTo(0, originY);
            ctx.lineTo(canvas.width, originY);
            ctx.stroke();

            // Vẽ cột độ cao
            const h_px = state.h * SCALE;
            ctx.fillStyle = '#64748b';
            ctx.fillRect(originX - 10, originY - h_px, 10, h_px);
            
            // Vẽ súng
            ctx.fillStyle = '#eab308';
            ctx.fillRect(originX - 10, originY - h_px - 10, 40, 20);

            // Vẽ vạch thước nền (Mỗi vạch 100mm)
            ctx.fillStyle = '#475569';
            ctx.font = '10px sans-serif';
            for(let i=0; i < 2000; i+=200) {
                let x_pos = originX + i * SCALE;
                if(x_pos > canvas.width) break;
                ctx.fillRect(x_pos, originY, 1, 5);
                ctx.fillText(i, x_pos, originY + 15);
            }

            // Vẽ bóng
            if(state.ball) {
                const bx = originX + state.ball.x * SCALE;
                const by = originY - state.ball.y * SCALE;
                
                ctx.beginPath();
                ctx.arc(bx, by, 5, 0, Math.PI*2);
                ctx.fillStyle = '#ef4444';
                ctx.fill();
            } else if (state.v0 > 0) {
                 // Vẽ điểm rơi lý thuyết (Gợi ý)
                 const targetX = originX + state.Ltt * SCALE;
                 ctx.beginPath();
                 ctx.arc(targetX, originY, 3, 0, Math.PI*2);
                 ctx.fillStyle = 'rgba(0, 255, 0, 0.5)';
                 ctx.fill();
                 ctx.fillStyle = '#4ade80';
                 ctx.fillText('L_tt', targetX - 10, originY - 10);
            }
        }

        // --- 3. LOGIC THƯỚC ĐO ---
        function setupRuler() {
            const ruler = document.getElementById('ruler');
            const display = document.getElementById('rulerVal');
            const measureRes = document.getElementById('measureResult');
            let isDragging = false;

            const originX = 50; // Trùng với drawScene

            const onMove = (clientX) => {
                // Tính vị trí relative trong container
                const rect = canvas.parentElement.getBoundingClientRect();
                let x = clientX - rect.left;
                
                // Giới hạn
                if(x < 0) x = 0;
                if(x > rect.width) x = rect.width;

                ruler.style.left = x + 'px';
                
                // Tính khoảng cách thực tế (mm)
                // Vị trí mũi tên thước so với gốc tọa độ (originX)
                // Lưu ý: Mũi tên nằm ở giữa ruler div. ruler div style left là x.
                // Ta căn chỉnh sao cho đầu mũi tên trỏ đúng tọa độ x
                
                let distPx = x - originX;
                if(distPx < 0) distPx = 0;
                
                let distMM = distPx / SCALE;
                state.Ltn = Math.round(distMM);
                
                display.textContent = state.Ltn + " mm";
                measureRes.textContent = state.Ltn + " mm";
            };

            ruler.addEventListener('mousedown', () => isDragging = true);
            window.addEventListener('mouseup', () => isDragging = false);
            window.addEventListener('mousemove', (e) => {
                if(isDragging) onMove(e.clientX);
            });
            
            // Touch support
            ruler.addEventListener('touchstart', () => isDragging = true);
            window.addEventListener('touchend', () => isDragging = false);
            window.addEventListener('touchmove', (e) => {
                if(isDragging) onMove(e.touches[0].clientX);
            });
        }

        // --- 4. GHI BẢNG ---
        function recordData() {
            if(state.v0 === 0) {
                alert("Chưa có dữ liệu tính toán! Hãy nhập Δt và bấm 'Mô Phỏng' trước.");
                return;
            }

            measurementCount++;
            const table = document.getElementById('tableBody');
            const row = table.insertRow();
            
            // Tính sai số
            // Error = |Ltt - Ltn| / Ltt * 100
            const error = Math.abs(state.Ltt - state.Ltn) / state.Ltt * 100;

            row.innerHTML = `
                <td class="font-bold text-slate-300">${measurementCount}</td>
                <td>${state.dt.toFixed(2)}</td>
                <td class="text-green-400 font-mono">${state.v0.toFixed(3)}</td>
                <td class="text-purple-400 font-bold">${state.Ltn}</td>
                <td class="text-slate-400">${state.Ltt.toFixed(1)}</td>
                <td class="${error < 5 ? 'text-green-400' : 'text-red-400'} font-bold">${error.toFixed(2)}%</td>
            `;
            
            // Scroll xuống dưới cùng bảng
            const container = document.querySelector('.overflow-auto');
            container.scrollTop = container.scrollHeight;
        }
        
        function clearTable() {
            document.getElementById('tableBody').innerHTML = '';
            measurementCount = 0;
        }

        init();
    </script>
</body>
</html>